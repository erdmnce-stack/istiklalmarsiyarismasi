// 1. FIREBASE AYARLARI (Kendi bilgilerini buraya yapıştır)
const firebaseConfig = {
    apiKey: "AIzaSyBfMm6VcVQ3GoqqsNKbHM2PN1akJFzki_s",
    authDomain: "istiklalmarsiyarismasi.firebaseapp.com",
    databaseURL: "https://istiklalmarsiyarismasi-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "istiklalmarsiyarismasi",
    storageBucket: "istiklalmarsiyarismasi.firebasestorage.app",
    messagingSenderId: "78708182382",
    appId: "1:78708182382:web:efe75268cbdc77c682057f"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// 2. SORU BANKASI (20 SORU)
const questions = [
    { q: "İstiklal Marşı hangi tarihte kabul edilmiştir?", a: ["12 Mart 1921", "29 Ekim 1923", "23 Nisan 1920", "30 Ağustos 1922"], c: 0 },
    { q: "Mehmet Âkif Ersoy, İstiklal Marşı'nı nerede yazmıştır?", a: ["Ankara Palas", "Taceddin Dergâhı", "Çankaya Köşkü", "Meclis Binası"], c: 1 },
    { q: "İstiklal Marşı hangi ordumuza ithaf edilmiştir?", a: ["Jandarma Kuvvetleri", "Deniz Kuvvetleri", "Kahraman Türk Ordusu", "Kuvayı Milliye"], c: 2 },
    { q: "İstiklal Marşı'nın bestecisi kimdir?", a: ["Mehmet Âkif Ersoy", "Zeki Üngör", "Osman Zeki Üngör", "Cemal Reşit Rey"], c: 2 },
    { q: "Mehmet Âkif Ersoy, ödül olarak verilen parayı nereye bağışlamıştır?", a: ["Kızılay", "Darülmesai", "Çocuk Esirgeme Kurumu", "Türk Hava Kurumu"], c: 1 },
    { q: "İstiklal Marşı toplam kaç kıtadan oluşmaktadır?", a: ["8", "9", "10", "12"], c: 2 },
    { q: "Mehmet Âkif Ersoy'un şiirlerini topladığı eserin adı nedir?", a: ["Safahat", "Çile", "Han-ı Yağma", "Kendi Gök Kubbemiz"], c: 0 },
    { q: "İstiklal Marşı yarışmasına toplam kaç şiir katılmıştır?", a: ["524", "724", "100", "124"], c: 1 },
    { q: "İstiklal Marşı'nın ilk iki kıtası hangi ölçü ile yazılmıştır?", a: ["Hece Ölçüsü", "Serbest Ölçü", "Aruz Ölçüsü", "Mani Tipi"], c: 2 },
    { q: "İstiklal Marşı mecliste ilk kez kim tarafından okunmuştur?", a: ["Mustafa Kemal Atatürk", "Hamdullah Suphi Tanrıöver", "İsmet İnönü", "Kazım Karabekir"], c: 1 },
    { q: "Mehmet Âkif Ersoy aslen nerelidir (Babası)?", a: ["İstanbul", "Ankara", "Arnavutluk (İpek)", "Burdur"], c: 2 },
    { q: "Mehmet Âkif Ersoy'un asıl mesleği nedir?", a: ["Öğretmen", "Asker", "Veteriner Hekim", "Mühendis"], c: 2 },
    { q: "İstiklal Marşı'nın kabul edildiği dönemde Milli Eğitim Bakanı (Maarif Vekili) kimdir?", a: ["Hamdullah Suphi Tanrıöver", "Reşit Galip", "Hasan Ali Yücel", "Tevfik İleri"], c: 0 },
    { q: "Mehmet Âkif Ersoy hangi ilin milletvekilliğini yapmıştır?", a: ["İstanbul", "Ankara", "Burdur", "Çanakkale"], c: 2 },
    { q: "Korkma, sönmez bu şafaklarda yüzen al sancak; / Sönmeden yurdumun üstünde tüten en son ...?", a: ["Ocak", "Bayrak", "Yıldız", "Şafak"], c: 0 },
    { q: "Mehmet Âkif Ersoy ne zaman vefat etmiştir?", a: ["27 Aralık 1936", "10 Kasım 1938", "12 Mart 1921", "29 Ekim 1923"], c: 0 },
    { q: "Mehmet Âkif, Safahat'ın hangi bölümünde Çanakkale şehitlerine yer vermiştir?", a: ["Süleymaniye Kürsüsünde", "Asım", "Hakkın Sesleri", "Hatıralar"], c: 1 },
    { q: "İstiklal Marşı ilk olarak hangi gazetede yayınlanmıştır?", a: ["Hâkimiyet-i Milliye", "Açıksöz", "İrade-i Milliye", "Vakit"], c: 1 },
    { q: "Aşağıdakilerden hangisi Safahat'ın bölümlerinden biri değildir?", a: ["Fatih Kürsüsünde", "Gölgeler", "Çile", "Süleymaniye Kürsüsünde"], c: 2 },
    { q: "Mehmet Âkif Ersoy, İstiklal Marşı'nı neden Safahat'a almamıştır?", a: ["Unuttuğu için", "Milletin eseri olduğu için", "Şiiri beğenmediği için", "Sığmadığı için"], c: 1 }
];

// 3. DEĞİŞKENLER VE MANTIK
let myData = { name: "", role: "", room: "", score: 0, totalTime: 0 };
let currentQuestionIndex = 0;
let timerInterval;

function joinQuiz() {
    myData.name = document.getElementById('userName').value;
    myData.role = document.getElementById('userRole').value;
    myData.room = document.getElementById('roomCode').value;

    if (!myData.name || !myData.room) return alert("Lütfen isim ve oda kodunu girin!");

    db.ref('rooms/' + myData.room + '/status').once('value', (snap) => {
        if (snap.val() === 'started' && myData.role === 'competitor') {
            alert("Yarışma başladı, katılamazsınız!");
        } else {
            document.getElementById('login-view').style.display = 'none';
            document.getElementById('quiz-view').style.display = 'block';
            startApp();
        }
    });
}

function startApp() {
    if (myData.role === 'host') {
        document.getElementById('admin-controls').style.display = 'block';
        db.ref('rooms/' + myData.room).set({ status: 'waiting', currentQuestion: 0 });
    }

    db.ref('rooms/' + myData.room + '/currentQuestion').on('value', (snap) => {
        currentQuestionIndex = snap.val();
        if (currentQuestionIndex !== null && currentQuestionIndex < questions.length) {
            displayQuestion(currentQuestionIndex);
        } else if (currentQuestionIndex >= questions.length) {
            showResults();
        }
    });
}

function displayQuestion(index) {
    const q = questions[index];
    document.getElementById('question-text').innerText = q.q;
    document.getElementById('question-count').innerText = `Soru: ${index + 1}/${questions.length}`;
    const container = document.getElementById('options-container');
    container.innerHTML = "";

    q.a.forEach((opt, i) => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerText = opt;
        btn.onclick = () => submitAnswer(i, index, btn);
        container.appendChild(btn);
    });

    startTimer();
}

function startTimer() {
    clearInterval(timerInterval);
    let timeLeft = 20;
    document.getElementById('timer').innerText = timeLeft;
    document.getElementById('next-btn').disabled = true;
    
    timerInterval = setInterval(() => {
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft;
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            disableOptions();
            if (myData.role === 'host') document.getElementById('next-btn').disabled = false;
        }
    }, 1000);
}

function submitAnswer(choice, qIndex, btn) {
    clearInterval(timerInterval);
    disableOptions();
    
    const timeTaken = 20 - parseInt(document.getElementById('timer').innerText);
    const isCorrect = choice === questions[qIndex].c;

    if (isCorrect) {
        btn.classList.add('correct');
        myData.score += 5;
        myData.totalTime += timeTaken;
    } else {
        btn.classList.add('wrong');
        myData.totalTime += 20; // Hatalı/Boş cevap cezası
    }

    db.ref('rooms/' + myData.room + '/users/' + myData.name).set({
        score: myData.score,
        time: myData.totalTime
    });

    if (myData.role === 'host') {
        document.getElementById('next-btn').disabled = false;
    }
}

function disableOptions() {
    const btns = document.querySelectorAll('.option-btn');
    btns.forEach(b => b.disabled = true);
}

function nextQuestion() {
    db.ref('rooms/' + myData.room + '/currentQuestion').set(currentQuestionIndex + 1);
}

function showResults() {
    document.getElementById('quiz-view').style.display = 'none';
    document.getElementById('result-view').style.display = 'block';
    
    db.ref('rooms/' + myData.room + '/users').once('value', (snap) => {
        const users = [];
        snap.forEach(u => { users.push({ name: u.key, ...u.val() }); });
        users.sort((a, b) => b.score - a.score || a.time - b.time);
        
        const list = document.getElementById('final-leaderboard');
        list.innerHTML = "<h3>Sıralama:</h3>" + users.map((u, i) => 
            `<p>${i+1}. ${u.name} - ${u.score} Puan - Toplam Süre: ${u.time} sn</p>`
        ).join("");
    });
}